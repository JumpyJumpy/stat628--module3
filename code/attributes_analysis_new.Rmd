```{r}

## By T Luo ##
library(tidytext)
library(tidyr)
library(dplyr)
library(stringr)
library(tidyverse)
library(magrittr)
library(MASS)
library(car)


setwd("/Users/ranee/Desktop/data1")
business <- read_csv("business_flattened.csv")
review <- read_csv("filtered_reviews.csv")
review$business_id <- factor(review$business_id)


star_avg <- tapply(review$stars, review$business_id, mean)
star_avg <- data.frame(stars = star_avg, business_id = names(star_avg))

dataset <- merge(business, star_avg, by = "business_id")
write.csv(dataset, "dataset.csv")


## get data ##
## mark NA as one level ##
anova <- read.csv("business_flattened.csv", na.strings = NULL)[, c(2, 10, 16, 24, 31, 20, 30, 23, 25, 51:64)]
summary(anova)


anova$RestaurantsPriceRange2[is.na(anova$RestaurantsPriceRange2)] <- 0
anova$RestaurantsPriceRange2 <- factor(anova$RestaurantsPriceRange2)

## data processing ##
anova$WiFi <- gsub("u'free'", "FREE", anova$WiFi)
anova$WiFi <- gsub("'free'", "FREE", anova$WiFi)
anova$WiFi <- gsub("'no'", "NO", anova$WiFi)
anova$WiFi <- gsub("u'no'", "NO", anova$WiFi)
anova$WiFi <- gsub("u'paid'", "PAID", anova$WiFi)
anova$WiFi <- gsub("uNO", "", anova$WiFi)
anova$WiFi <- gsub("'paid'", "PAID", anova$WiFi)
anova$RestaurantsTakeOut <- gsub("None", "", anova$RestaurantsTakeOut)
anova$RestaurantsDelivery <- gsub("None", "", anova$RestaurantsDelivery)
anova$OutdoorSeating <- gsub("None", "", anova$OutdoorSeating)
anova$HasTV <- gsub("None", "", anova$HasTV)
anova$RestaurantsReservations <- gsub("None", "", anova$RestaurantsReservations)
anova$RestaurantsPriceRange2 <- gsub("0", "", anova$RestaurantsPriceRange2)
anova[which(anova == "", arr.ind = T)] <- "NA"

anova_factor <- cbind(anova[, c(1, 2)], as.data.frame(lapply(anova[, -c(1, 2)], factor)))
colnames(anova_factor)[1] <- "business_id"


model <- lm(stars ~ . - (business_id), data = anova_factor)
summary(model)
## anova model ##
model <- aov(stars ~ . - business_id, data = anova_factor)
summary(model)


library(xtable)
print(xtable(anova(model)))



# Plotting
anova$stars[which(anova$stars==1.5)] = floor(anova$stars[which(anova$stars==1.5)])
anova$stars[which(anova$stars==2.5)] = floor(anova$stars[which(anova$stars==2.5)])
anova$stars[which(anova$stars==3.5)] = floor(anova$stars[which(anova$stars==3.5)])
anova$stars[which(anova$stars==4.5)] = floor(anova$stars[which(anova$stars==4.5)])


## Restaurant Delivery
# Plot Restaurant Delivery by Stars (Proportion)
library(ggplot2)
library(wesanderson)

# Plot Restaurant Delivery by Stars (Proportion)
plot_RD = ggplot(anova,aes(x=stars,fill=RestaurantsDelivery))+geom_bar(aes(y=(..count..)/tapply(..count.., ..fill.. ,sum)[..fill..]),position = position_dodge()) + ggtitle("Restaurants Delivery") 
plot_RD + theme(text = element_text(size=10),legend.title = element_blank(),plot.title = element_text(hjust = 0.4)) +scale_fill_manual(values=wes_palette(n=3,name="Darjeeling1"))+
  xlab("Stars") +ylab("Proportion")


# Plot Average Rating by Restaurant Delivery
RD_false_index= which(anova$RestaurantsDelivery == "False")
RD_true_index = which(anova$RestaurantsDelivery == "True")
avg_rating_RD = c(mean(anova$stars[RD_false_index]),mean(anova$stars[RD_true_index]))
rd = c("False","True")
avg_rating_RD_dat = as.data.frame(cbind(avg_rating_RD,rd))
avg_rating_RD_dat$avg_rating_RD=as.numeric(as.character(avg_rating_RD_dat$avg_rating_RD))
colnames(avg_rating_RD_dat)[1] = "AverageRating"; colnames(avg_rating_RD_dat)[2] = "RestaurantsDelivery"
plot_avg_rating_RD = ggplot(avg_rating_RD_dat,aes(x=RestaurantsDelivery,y= AverageRating,fill= RestaurantsDelivery))+geom_bar(stat = "identity") 
plot_avg_rating_RD+theme(text = element_text(size=20),legend.position="none",plot.title = element_text(hjust = 0.5))+ scale_y_continuous(limits = c(0, 5))+ xlab("Business Parking") + ylab("Average Rating")+
  geom_text(stat="identity",aes(label=round(AverageRating,digits=4)),size=8)+scale_fill_manual(values=wes_palette(n=3,name="Darjeeling1"))

# p <- ggplot(data = avg_rating_RD_dat, mapping = aes(
  # x = RestaurantsDelivery, y = AverageRating ))

# p  + theme(text = element_text(size=20),legend.position="none",plot.title = element_text(hjust = 0.5))+ 
  # scale_y_continuous(limits = c(0, 5))+ xlab("Restaurants Delivery") + 
  # ylab("Average Rating")+geom_text(stat="identity",aes(label=round(AverageRating,digits=4)),size=8)+
  # scale_fill_manual(values=wes_palette(n=3,name="Darjeeling1"))


library(car)
# p < 2.2e-16 
leveneTest(anova$stars ~ anova$RestaurantsDelivery)

# two-sample t-test
# p-value < 2.2e-16
# not equal
t.test(anova$stars[RD_false_index],anova$stars[RD_true_index],
       paired = FALSE,var.equal = FALSE)
length(anova$stars[RD_false_index])
length(RD_false_index)
## Business Parking garage
# Plot Business Parking by Stars (Proportion)
plot_garage = ggplot(anova,aes(x=stars,fill=garage))+geom_bar(aes(y=(..count..)/tapply(..count.., ..fill.. ,sum)[..fill..]),position = position_dodge()) + ggtitle("garage") 
plot_garage + theme(text = element_text(size=10),legend.title = element_blank(),plot.title = element_text(hjust = 0.4)) +scale_fill_manual(values=wes_palette(n=3,name="Darjeeling1"))+
  xlab("Stars") +ylab("Proportion")


# Plot Average Rating by Business Parking
BP_false_index= which(anova$garage=="False")
BP_true_index = which(anova$garage=="True")
avg_rating_BP = c(mean(anova$stars[BP_false_index]),mean(anova$stars[BP_true_index]))
bp = c("False","True")
avg_rating_BP_dat = as.data.frame(cbind(avg_rating_BP,bp))
avg_rating_BP_dat$avg_rating_BP=as.numeric(as.character(avg_rating_BP_dat$avg_rating_BP))
colnames(avg_rating_BP_dat)[1] = "AverageRating"; colnames(avg_rating_BP_dat)[2] = "BusinessParking"
plot_avg_rating_BP = ggplot(avg_rating_BP_dat,aes(x=BusinessParking,y= AverageRating,fill= BusinessParking))+geom_bar(stat = "identity") 
plot_avg_rating_BP+theme(text = element_text(size=20),legend.position="none",plot.title = element_text(hjust = 0.5))+ scale_y_continuous(limits = c(0, 5))+ xlab("Business Parking") + ylab("Average Rating")+
  geom_text(stat="identity",aes(label=round(AverageRating,digits=4)),size=8)+scale_fill_manual(values=wes_palette(n=3,name="Darjeeling1"))

# p < 2.2e-16
leveneTest(anova$stars ~ anova$garage)
# p-value < 2.2e-16
t.test(anova$stars[BP_false_index],anova$stars[BP_true_index],
       paired = FALSE,var.equal = FALSE)


## Outdoor Seating
# Plot Outdoor Seating by Stars (Proportion)
plot_OS = ggplot(anova,aes(x=stars,fill=OutdoorSeating))+geom_bar(aes(y=(..count..)/tapply(..count.., ..fill.. ,sum)[..fill..]),position = position_dodge()) + ggtitle("Outdoor Seating") 
plot_OS + theme(text = element_text(size=10),legend.title = element_blank(),plot.title = element_text(hjust = 0.4)) +scale_fill_manual(values=wes_palette(n=3,name="Darjeeling1"))+
  xlab("Stars") +ylab("Proportion")

# Plot Average Rating by Outdoor Seating
OS_false_index= which(anova$OutdoorSeating=="False")
OS_true_index = which(anova$OutdoorSeating=="True")
avg_rating_OS = c(mean(anova$stars[OS_false_index]),mean(anova$stars[OS_true_index]))
OS = c("False","True")
avg_rating_OS_dat = as.data.frame(cbind(avg_rating_OS,OS))
avg_rating_OS_dat$avg_rating_OS=as.numeric(as.character(avg_rating_OS_dat$avg_rating_OS))
colnames(avg_rating_OS_dat)[1] = "AverageRating"; colnames(avg_rating_OS_dat)[2] = "OutdoorSeating"
plot_avg_rating_OS = ggplot(avg_rating_OS_dat,aes(x=OutdoorSeating,y= AverageRating,fill= OutdoorSeating))+geom_bar(stat = "identity") 
plot_avg_rating_OS+theme(text = element_text(size=20),legend.position="none",plot.title = element_text(hjust = 0.5))+ scale_y_continuous(limits = c(0, 5))+ xlab("Outdoor Seating") + ylab("Average Rating")+
  geom_text(stat="identity",aes(label=round(AverageRating,digits=4)),size=8)+scale_fill_manual(values=wes_palette(n=2,name="Darjeeling1"))

# p < 2.2e-16
leveneTest(anova$stars ~ anova$OutdoorSeating)
# p-value < 2.2e-16
t.test(anova$stars[OS_false_index],anova$stars[OS_true_index],
       paired = FALSE,var.equal = FALSE)



## Has TV
# Plot HasTV by Stars (Proportion)
plot_TV = ggplot(anova,aes(x=stars,fill=HasTV))+geom_bar(aes(y=(..count..)/tapply(..count.., ..fill.. ,sum)[..fill..]),position = position_dodge()) + ggtitle("HasTV") 
plot_TV + theme(text = element_text(size=10),legend.title = element_blank(),plot.title = element_text(hjust = 0.4)) +scale_fill_manual(values=wes_palette(n=3,name="Darjeeling1"))+
  xlab("Stars") +ylab("Proportion")



# Plot Average Rating by Restaurant Reservations
RR_false_index= which(anova$RestaurantsReservations=="False")
RR_true_index = which(anova$RestaurantsReservations=="True")
avg_rating_RR = c(mean(anova$stars[RR_false_index]),mean(anova$stars[RR_true_index]))
rr = c("False","True")
avg_rating_RR_dat = as.data.frame(cbind(avg_rating_RR,rr))
avg_rating_RR_dat$avg_rating_RR=as.numeric(as.character(avg_rating_RR_dat$avg_rating_RR))
colnames(avg_rating_RR_dat)[1] = "AverageRating"; colnames(avg_rating_RR_dat)[2] = "RestaurantsReservations"
plot_avg_rating_RR = ggplot(avg_rating_RR_dat,aes(x=RestaurantsReservations,y= AverageRating,fill= RestaurantsReservations))+geom_bar(stat = "identity") 
plot_avg_rating_RR+theme(text = element_text(size=20),legend.position="none",plot.title = element_text(hjust = 0.5))+ scale_y_continuous(limits = c(0, 5))+ xlab("Restaurants Reservations") + ylab("Average Rating")+
  geom_text(stat="identity",aes(label=round(AverageRating,digits=4)),size=8)+scale_fill_manual(values=wes_palette(n=2,name="Darjeeling1"))

# p < 2.2e-16 
leveneTest(anova$stars ~ anova$RestaurantsReservations)
# p-value < 2.2e-16
t.test(anova$stars[RR_false_index],anova$stars[RR_true_index],
       paired = FALSE,var.equal = FALSE)


## PriceRange
# Plot Price Range by Stars (Proportion)
plot_PR = ggplot(anova,aes(x=stars,fill=RestaurantsPriceRange2))+geom_bar(aes(y=(..count..)/tapply(..count.., ..fill.. ,sum)[..fill..])) + ggtitle("Restaurants Price Range") 
plot_PR + theme(text = element_text(size=10),legend.title = element_blank(),plot.title = element_text(hjust = 0.4)) +scale_fill_manual(values=wes_palette(n=5,name="Darjeeling1"))+
  xlab("Stars") +ylab("Proportion")

# Plot Average rating by Price Range
PR_1_index = which(anova$RestaurantsPriceRange2==1)
PR_2_index = which(anova$RestaurantsPriceRange2==2)
PR_3_index = which(anova$RestaurantsPriceRange2==3)
PR_4_index = which(anova$RestaurantsPriceRange2==4)
PR_5_index = which(anova$RestaurantsPriceRange2=="NA")
avg_rating_PR = c(mean(anova$stars[PR_1_index]),mean(anova$stars[PR_2_index]),mean(anova$stars[PR_3_index]),mean(anova$stars[PR_4_index]))
PR = c("1","2","3","4","NA")
avg_rating_PR_dat = as.data.frame(cbind(avg_rating_PR,PR))
avg_rating_PR_dat$avg_rating_PR=as.numeric(as.character(avg_rating_PR_dat$avg_rating_PR))
colnames(avg_rating_PR_dat)[1] = "AverageRating"; colnames(avg_rating_PR_dat)[2] = "PriceRange"
plot_avg_rating_PR = ggplot(avg_rating_PR_dat,aes(x=PriceRange,y= AverageRating,fill= PriceRange))+geom_bar(stat = "identity") 
plot_avg_rating_PR+theme(text = element_text(size=20),legend.position="none",plot.title = element_text(hjust = 0.5))+ scale_y_continuous(limits = c(0, 5))+ xlab("Price Range") + ylab("Average Rating")+
  geom_text(stat="identity",aes(label=round(AverageRating,digits=4)),size=8)+scale_fill_manual(values=wes_palette(n=5,name="Darjeeling1"))

# p <2e-16
fit_PR = aov(anova$stars ~ anova$RestaurantsPriceRange2)
summary(fit_PR)
# 2-1, 4-2 significant
TukeyHSD(fit_PR)


## Street
# Plot Street by Stars (Proportion)
plot_bike = ggplot(anova,aes(x=stars,fill=street))+geom_bar(aes(y=(..count..)/tapply(..count.., ..fill.. ,sum)[..fill..]),position = position_dodge()) + ggtitle("street") 
plot_bike + theme(text = element_text(size=10),legend.title = element_blank(),plot.title = element_text(hjust = 0.4)) +scale_fill_manual(values=wes_palette(n=3,name="Darjeeling1"))+
  xlab("Stars") +ylab("Proportion")

# Plot Average Rating by Bike Parking
bike_false_index= which(anova$street=="False")
bike_true_index = which(anova$street=="True")
avg_rating_bike = c(mean(anova$stars[bike_false_index]),mean(anova$stars[bike_true_index]))
bike = c("False","True")
avg_rating_bike_dat = as.data.frame(cbind(avg_rating_bike,bike))
avg_rating_bike_dat$avg_rating_bike=as.numeric(as.character(avg_rating_bike_dat$avg_rating_bike))
colnames(avg_rating_bike_dat)[1] = "AverageRating"; colnames(avg_rating_bike_dat)[2] = "street"
plot_avg_rating_bike = ggplot(avg_rating_bike_dat,aes(x=street,y= AverageRating,fill= street))+geom_bar(stat = "identity") 
plot_avg_rating_bike+theme(text = element_text(size=20),legend.position="none",plot.title = element_text(hjust = 0.5))+ scale_y_continuous(limits = c(0, 5))+ xlab("Bike Parking") + ylab("Average Rating")+
  geom_text(stat="identity",aes(label=round(AverageRating,digits=4)),size=8)+scale_fill_manual(values=wes_palette(n=2,name="Darjeeling1"))

# p = 0.0002134 
leveneTest(anova$stars ~ anova$street)
# p-value = 1.878e-10
t.test(anova$stars[bike_false_index],anova$stars[bike_true_index],
       paired = FALSE,var.equal = FALSE)


## GoodForGroups
# Plot GoodForGroups by Stars (Proportion)
plot_groups = ggplot(anova,aes(x=stars,fill=lot))+geom_bar(aes(y=(..count..)/tapply(..count.., ..fill.. ,sum)[..fill..]),position = position_dodge()) + ggtitle("lot") 
plot_groups + theme(text = element_text(size=20),legend.title = element_blank(),plot.title = element_text(hjust = 0.4)) +scale_fill_manual(values=wes_palette(n=3,name="Darjeeling1"))+
  xlab("Stars") +ylab("Proportion")

# Plot Average Rating by GoodForGroups
groups_false_index= which(anova$lot=="False")
groups_true_index = which(anova$lot=="True")
avg_rating_groups = c(mean(anova$stars[groups_false_index]),mean(anova$stars[groups_true_index]))
groups = c("False","True")
avg_rating_groups_dat = as.data.frame(cbind(avg_rating_groups,groups))
avg_rating_groups_dat$avg_rating_groups=as.numeric(as.character(avg_rating_groups_dat$avg_rating_groups))
colnames(avg_rating_groups_dat)[1] = "AverageRating"; colnames(avg_rating_groups_dat)[2] = "GoodForGroups"
plot_avg_rating_groups = ggplot(avg_rating_groups_dat,aes(x=GoodForGroups,y= AverageRating,fill= GoodForGroups))+geom_bar(stat = "identity") 
plot_avg_rating_groups+theme(text = element_text(size=20),legend.position="none",plot.title = element_text(hjust = 0.5))+ scale_y_continuous(limits = c(0, 5))+ xlab("Restaurants Good For Groups") + ylab("Average Rating")+
  geom_text(stat="identity",aes(label=round(AverageRating,digits=4)),size=8)+scale_fill_manual(values=wes_palette(n=2,name="Darjeeling1"))

# p = 5.992e-06
leveneTest(anova$stars ~ anova$lot)
# p-value < 2.2e-16
t.test(anova$stars[groups_false_index],anova$stars[groups_true_index],
       paired = FALSE,var.equal = FALSE)

```